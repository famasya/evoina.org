---
import { Archive } from "@lucide/astro";
import { getCollection } from "astro:content";
import PageTitle from "../../components/PageTitle.astro";
import Layout from "../../layouts/Layout.astro";

export async function getStaticPaths() {
  const locale = "en";
  const pageSize = 5;
  const posts = await getCollection(
    "archives",
    ({ data }) => data.locale === locale,
  );
  const totalPages = Math.ceil(posts.length / pageSize);
  return Array.from({ length: totalPages }, (_, i) => ({
    params: { page: String(i + 1) },
  }));
}

const { page } = Astro.params;
const locale = "en";
const pageSize = 6;
const currentPage = parseInt(page ?? "1");

// Get the archives page content for the current locale
const archivesPages = await getCollection(
  "pages",
  ({ data }) => data.locale === locale,
);
const archivesPage = archivesPages.find((page) =>
  page.slug.endsWith("archives"),
);
if (!archivesPage)
  throw new Error(`Archives page not found for locale: ${locale}`);

// Get posts for the current locale
const posts = await getCollection(
  "archives",
  ({ data }) => data.locale === locale,
);
const categories = [...new Set(posts.map((post) => post.data.category))];
const sortedPosts = posts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

const totalPages = Math.ceil(sortedPosts.length / pageSize);
const paginatedPosts = sortedPosts.slice(
  (currentPage - 1) * pageSize,
  currentPage * pageSize,
);

const allText = "All";
const publishedText = "Published on:";
const postUrlPrefix = "/post/";
const archivesUrlPrefix = "/archives";
---

<Layout title={archivesPage.data.title}>
  <PageTitle title={archivesPage.data.page_title} />
  <section class="py-12">
    <div class="auto-padding">
      <div class="flex flex-wrap gap-2 mb-8 justify-center">
        <a
          href={archivesUrlPrefix}
          class="px-4 py-2 rounded-full border transition-colors bg-gray-800 text-white border-gray-800"
        >
          {allText}
        </a>
        {
          categories.map((category) => (
            <a
              href={`${archivesUrlPrefix}/${category}`}
              class="px-4 py-2 rounded-full border transition-colors bg-white text-gray-800 border-gray-200 hover:bg-gray-50 flex items-center gap-2"
            >
              <Archive size={16} />
              {category}
            </a>
          ))
        }
      </div>
      <ul class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {
          paginatedPosts.map((post) => (
            <li>
              <a
                href={`${postUrlPrefix}${post.slug.split("/").pop() || post.slug}`}
                class="block border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-shadow flex flex-col h-full"
              >
                {post.data.image && (
                  <img
                    src={post.data.image}
                    alt={post.data.title}
                    class="w-full h-48 object-cover"
                  />
                )}
                <div class="p-6 flex-grow">
                  <p class="text-sm text-gray-500 mb-2">{post.data.category}</p>
                  <h2 class="text-2xl font-serif mb-2">{post.data.title}</h2>
                  <p class="text-gray-600 mb-2">
                    {publishedText}{" "}
                    {post.data.pubDate.toLocaleDateString("en-US")}
                  </p>
                  <p class="text-lg">{post.data.description}</p>
                </div>
              </a>
            </li>
          ))
        }
      </ul>
      <div class="flex justify-center items-center gap-4 mt-8">
        {
          currentPage > 1 && (
            <a
              href={`/archives/${currentPage - 1}`}
              class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300"
            >
              Previous
            </a>
          )
        }
        <span>Page {currentPage} of {totalPages}</span>
        {
          currentPage < totalPages && (
            <a
              href={`/archives/${currentPage + 1}`}
              class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300"
            >
              Next
            </a>
          )
        }
      </div>
    </div>
  </section>
</Layout>
